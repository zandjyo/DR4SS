% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/LENGTH_BY_CATCH_short.r
\name{LENGTH_BY_CATCH_short}
\alias{LENGTH_BY_CATCH_short}
\title{Construct catch-weighted length compositions for Stock Synthesis}
\usage{
LENGTH_BY_CATCH_short(
  con_akfin,
  con_afsc,
  species,
  species_catch,
  for_species_catch,
  sp_area,
  ly,
  SEX = TRUE,
  PORT = TRUE
)
}
\arguments{
\item{species}{Observer species code.}

\item{species_catch}{Catch accounting species identifier used in blend catch.}

\item{for_species_catch}{Foreign catch species identifier.}

\item{sp_area}{Stock assessment area (e.g., "BS", "GOA", "AI").}

\item{ly}{Final year to include.}

\item{SEX}{Logical; if \code{TRUE}, length compositions are sex-specific.}

\item{PORT}{Logical; if \code{TRUE}, port sampling data are included.}
}
\value{
A list with two elements:
\describe{
\item{aggregated}{Annual length compositions for a single aggregated fishery.}
\item{by_gear}{Annual length compositions split by gear.}
}
}
\description{
Builds annual fishery length compositions by reweighting observed length
frequencies from at-sea observer and (optionally) port sampling so that they
are proportional to total catch in numbers derived from blend catch data.
Output is suitable for use as length composition input to Stock Synthesis,
either as a single aggregated fishery or split by gear.
}
\details{
This function combines length-frequency observations, species composition
expansions, and blend catch information to estimate length compositions that
reflect total fishery removals in numbers.

The workflow is:
\enumerate{
\item Pull observer and (optionally) port-based length-frequency data and
associated species composition expansions that provide an estimated number
of fish represented by each haul or delivery.
\item Pull domestic blend catch (and historical foreign catch, where
applicable), convert catch weight (tons) to numbers using an average weight
(AVEWT) estimated from observer data.
\item Distribute catch numbers across lengths using a hierarchical weighting
scheme that accounts for within-haul length proportions, haul-level
representation within strata, and stratum-level contributions to total
catch.
\item Produce annual length compositions either as a single aggregated
fishery or split by gear (HAL, POT, TRW).
\item Calculate auxiliary sample-size summaries (number of samples, hauls,
and strata); bootstrap effective sample sizes are retained as placeholders
for consistency with legacy implementations.
}

Length compositions are constructed on an integer length grid and are
normalized to sum to one within each year (and gear, if applicable). Strata
with insufficient observed sample size are excluded.
}
\section{Mathematical formulation}{


Let a stratum be indexed by
\deqn{s \equiv (y, a, g, m)}
where \eqn{y} is year, \eqn{a} is area (AREA2), \eqn{g} is gear, and \eqn{m} is
month. Let \eqn{h} index hauls or deliveries within stratum \eqn{s}, \eqn{l}
index integer length, and \eqn{k} index sex when \code{SEX = TRUE}.

Observed length frequency in haul \eqn{h}:
\deqn{f_{h,l,(k)}}

Total observed frequency in haul \eqn{h}:
\deqn{F_h = \sum_l f_{h,l,(k)}}

Estimated number of fish represented by haul \eqn{h}:
\deqn{N_h}

Total estimated numbers in stratum \eqn{s}:
\deqn{N_s = \sum_{h \in s} N_h}

Total catch in numbers from blend catch in stratum \eqn{s}:
\deqn{C_s}

with totals
\deqn{C_{y,g} = \sum_{a,m} C_{y,a,g,m}, \qquad
      C_y = \sum_{a,g,m} C_{y,a,g,m}}

Within-haul length proportion:
\deqn{p_{h,l,(k)} = \frac{f_{h,l,(k)}}{F_h}}

Haul weight within stratum:
\deqn{w_{h \mid s} = \frac{N_h}{N_s}}

For the single aggregated fishery model (all gears pooled within year),
stratum weight is:
\deqn{w^{single}_{s \mid y} = \frac{C_s}{C_y}}

and the contribution of haul \eqn{h} at length \eqn{l} is:
\deqn{
W^{single}_{h,l,(k)} =
p_{h,l,(k)} \cdot w_{h \mid s} \cdot w^{single}_{s \mid y}
}

For the split-by-gear model, stratum weight is:
\deqn{w^{gear}_{s \mid y,g} = \frac{C_s}{C_{y,g}}}

and the contribution becomes:
\deqn{
W^{gear}_{h,l,(k)} =
p_{h,l,(k)} \cdot w_{h \mid s} \cdot w^{gear}_{s \mid y,g}
}

Final length compositions are obtained by summing the appropriate weights
across hauls and strata and normalizing so that proportions sum to one.

Catch weight is converted to numbers using:
\deqn{
\hat{N} = \frac{\text{tons landed}}{\bar{w} / 1000}
}
where \eqn{\bar{w}} is the average individual weight estimated from observer
data using a hierarchical fallback across strata.

Only strata with at least 30 observed length counts are retained.
}

\references{
Alaska Fisheries Science Center. Stock assessment length composition
construction methods used in recent North Pacific groundfish assessments.
}
