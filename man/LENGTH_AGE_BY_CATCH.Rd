% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/LENGTH_AGE_BY_CATCH.r
\name{LENGTH_AGE_BY_CATCH}
\alias{LENGTH_AGE_BY_CATCH}
\title{Construct catch-weighted length or age compositions for Stock Synthesis}
\usage{
LENGTH_AGE_BY_CATCH(
  con_akfin,
  species,
  sp_area,
  start_year,
  end_year,
  SEX = TRUE,
  PORT = TRUE,
  age_length = c("LENGTH", "AGE"),
  map_sample = c("MAP", "sample"),
  max_length = NULL,
  max_age = 12L,
  max_wt = 50L,
  verbose = TRUE,
  seed = 1L,
  season_def = NULL,
  region_def = NULL,
  drop_unmapped = TRUE,
  wgoa_cod = TRUE
)
}
\arguments{
\item{con_akfin}{DBI connection to AKFIN.}

\item{species}{Numeric observer species code used in observer/port length SQL.}

\item{sp_area}{Stock assessment area code: "BS","AI","GOA","BSWGOA".
Used for default region filtering (if \code{region_def} is NULL) and passed to
age-predictor helper functions.}

\item{start_year}{First year to include (must be >= 1990).}

\item{end_year}{Last year to include.}

\item{SEX}{Logical. If TRUE, compositions are sex-specific (SS 1/2/3 coding).}

\item{PORT}{Logical. If TRUE, include port sampling data when available.}

\item{age_length}{"LENGTH" or "AGE". If "AGE", lengths are converted to predicted ages.}

\item{map_sample}{"MAP" or "sample" used by predict_age_from_lf() when returning integer ages.}

\item{max_length}{Optional numeric. If provided, drop rows in ALL_DATA with LENGTH > max_length
(applied before AGE prediction, so it affects the predictor inputs too).}

\item{max_age}{Plus-group maximum age (used when age_length="AGE").}

\item{verbose}{Logical. If TRUE, print data availability summaries while running.}

\item{seed}{RNG seed when sampling (used when age_length="AGE").}

\item{season_def}{Optional named list mapping season labels to month integers (1..12),
e.g. list(A=1:3,B=4:6,C=7:9,D=10:12) or list(A=1:6,B=7:12).}

\item{region_def}{Optional named list mapping REGION_GRP labels to AREA codes, e.g.
listlist(BS=c(500:539),WGOA=c(610),CGOA=c(620:649),EGOA=650:659),AI=c(541:544)). If provided, outputs are by REGION_GRP.
If NULL, a single REGION_GRP is used (equal to \code{sp_area}) and default area filtering is used.}

\item{drop_unmapped}{Logical. If TRUE and region_def is provided, drop rows whose AREA does not map
to a REGION_GRP. Default TRUE.}

\item{wgoa_cod}{Logical. If TRUE, moves catch from NMFS area 620 west of -158 longitude into the 610 region group}

\item{season_month}{Which month column to use for season mapping: "MONTH" or "MONTH_WED".
Default "MONTH".}
}
\value{
A list with two elements:
\describe{
\item{aggregated}{data.table of YEAR x REGION_GRP x LENGTH/AGE (and optionally SEASON/SEX) with FREQ and sample summaries.}
\item{by_gear}{data.table of YEAR x REGION_GRP x GEAR x LENGTH/AGE (and optionally SEASON/SEX) with FREQ and sample summaries.}
}
}
\description{
Builds annual fishery length (or age) compositions by reweighting observed
length-frequency samples (observer + optional port) so they are proportional
to total catch in numbers derived from AKFIN blend catch.

If \code{age_length="AGE"}, observed lengths are first converted to predicted ages
(bulk) using \code{predict_age_from_lf()} with an age predictor fit from:
(1) survey age data (Q3 backbone) and (2) fishery age data (quarter deltas),
plus shrinkage priors from fishery ages.

If \code{season_def} is provided, outputs are returned by YEAR x SEASON (and by GEAR,
and optionally SEX), where SEASON is a user-defined mapping of months to season
labels (e.g., quarters, halves, custom month groupings).

If \code{region_def} is provided, outputs are returned by YEAR x REGION_GRP (and
optionally SEASON, GEAR, SEX), where REGION_GRP is a user-defined mapping of
AKFIN/observer AREA codes (e.g., 500:539, 610, 620, etc.) to region labels.
}
\details{
Workflow:
\enumerate{
\item Pull observer length-frequency + species composition expansions (AKFIN).
\item Optionally pull port length-frequency across eras:
\itemize{
\item 1990–1998 (AKFIN)
\item 1999–2007 (AKFIN lengths + AKFIN fish tickets; uses fuzzy matching)
\item 2008–2010 (AKFIN lengths + fuzzy matching to fish tickets)
\item 2011–present (AKFIN; direct landings fields)
The \code{fuzzy_dates()} steps are retained because they are required to recover
port samples that do not join to fish tickets by ID.
}
\item Optionally filter ALL_DATA by \code{max_length} (removes LENGTH > max_length).
\item If AGE mode, build predictor and convert LENGTH -> AGE_HAT in bulk.
\item Pull blend catch (AKFIN) and convert tons to numbers using AVEWT derived
from observer data with hierarchical fallback across strata.
\item Compute hierarchical weights and produce compositions (optionally by season
and/or user-defined region group).
}
}
