% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/fishery_cond_age_length.R
\name{fishery_cond_age_length}
\alias{fishery_cond_age_length}
\title{Fishery conditional age-at-length (CAAL) compositions in Stock Synthesis format}
\usage{
fishery_cond_age_length(
  con_akfin,
  species,
  start_year,
  end_year,
  season_def,
  region_def,
  max_age,
  len_bins,
  drop_unmapped = TRUE,
  one_fleet = TRUE,
  wgoa_cod = TRUE,
  wt = 1,
  ageerr = 1
)
}
\arguments{
\item{con_akfin}{A DBI connection to the AKFIN database.}

\item{species}{Species code passed to \code{get_fishery_age_wt_data()}.}

\item{start_year, end_year}{Inclusive year range.}

\item{season_def}{Named list mapping season labels to months (passed through to the data pull).}

\item{region_def}{Named list mapping region labels to AREA codes (passed through to the data pull).}

\item{max_age}{Integer maximum age for plus-grouping.}

\item{len_bins}{Numeric vector of length bin labels (must be length >= 2). Values are sorted/unique.}

\item{drop_unmapped}{Logical; drop observations whose AREA does not map into \code{region_def}.}

\item{one_fleet}{Logical; if TRUE, pool across gears into a single fleet (fleet = 1).}

\item{wgoa_cod}{Logical; optional WGOA recoding logic passed to the data pull.}

\item{wt}{Numeric scalar multiplier applied to \code{Nsamp}.}

\item{ageerr}{Integer age-error definition code written to the \code{Ageerr} column.}
}
\value{
A named list with element \code{norm}, a \code{data.frame} in Stock Synthesis
conditional age-at-length format. If no data are available, returns an empty table with
the correct columns.
}
\description{
Builds conditional age-at-length compositions from fishery ageing data by
year, season, region, and (optionally) fleet. Ages are plus-grouped at
\code{max_age} and lengths are assigned to user-supplied bins \code{len_bins}.
}
\details{
The function pulls fishery age/length observations via
\code{get_fishery_age_wt_data()} and constructs conditional age-at-length
proportions within each Year Ã— LengthBin (and strata defined by season/region/fleet).

For each stratum, year, and length bin \eqn{l}, the output proportions are:
\deqn{p(a \mid l) = \frac{n_{a,l}}{\sum_a n_{a,l}}}
where \eqn{n_{a,l}} is the number of observations at age \eqn{a} in length bin \eqn{l}.
Ages are filtered to \code{AGE > 0}, so the \code{a0} column (age 0) will be zero.

Length binning uses \code{findInterval()} against \code{len_bins}. Values below the
first bin are assigned to the first bin; values above the last bin are assigned to
the last bin (a plus bin).

The returned table follows Stock Synthesis CAAL conventions with columns:
\code{Yr, Seas, Flt, Gender, Part, Ageerr, Lbin_lo, Lbin_hi, Nsamp, a0..aMax}.
In this implementation \code{Lbin_lo == Lbin_hi == BIN} (bin labels), consistent with
historical single-value bin conventions; if edge-based bins are desired, modify the
\code{Lbin_lo/Lbin_hi} construction accordingly.
}
\seealso{
\code{\link[data.table]{dcast}}, \code{get_fishery_age_wt_data}
}
