% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/foreign_length_by_catch.R
\name{foreign_length_by_catch}
\alias{foreign_length_by_catch}
\title{Foreign length composition weighted by foreign catch}
\usage{
foreign_length_by_catch(
  con_akfin,
  species = 202,
  for_species_catch = "PACIFIC COD",
  start_year,
  end_year,
  SEX = TRUE,
  season_def = list(A = 1:4, B = 5:12),
  region_def = list(BS = c(50:53, 500:539), WGOA = c(61, 610), CGOA = c(62, 63, 64,
    620:649), EGOA = c(65, 650:659), AI = c(54, 540:544)),
  drop_unmapped = TRUE,
  wgoa_cod = TRUE,
  verbose = TRUE
)
}
\arguments{
\item{con_akfin}{A live DBI connection to the AKFIN (or equivalent) database used by
\code{sql_run()}.}

\item{species}{Numeric species code used in the length-frequency query (e.g., 202).}

\item{for_species_catch}{Character species label used in the catch query (e.g., \code{"PACIFIC COD"}).}

\item{start_year, end_year}{Numeric scalar years defining the inclusive year range.}

\item{SEX}{Logical; if \code{TRUE}, keep sex-specific compositions (expects a \code{SEX} column).
If \code{FALSE}, sexes are pooled.}

\item{season_def}{Optional named list mapping seasons to months, e.g.
\code{list(A = 1:4, B = 5:12)}. If provided, outputs include \code{SEASON} and months not mapped
are dropped (with a message when \code{verbose=TRUE}).}

\item{region_def}{Named list mapping region labels to AREA codes. Must be non-overlapping.
Default corresponds to common Alaska groundfish groupings (BS/WGOA/CGOA/EGOA/AI).}

\item{drop_unmapped}{Logical; drop rows whose AREA does not map into \code{region_def}.}

\item{wgoa_cod}{Logical; if \code{TRUE}, optionally remaps selected WGOA areas based on longitude
(see code block).}

\item{verbose}{Logical; emit summaries and progress messages.}
}
\value{
A named list with two \code{data.table}s:
\describe{
\item{\code{aggregated}}{Compositions aggregated across gear. Columns include REGION_GRP, YEAR,
LENGTH (and optionally SEASON, SEX), FREQ, plus sample size summaries (NSAMP, NHAUL, NSTRATA).}
\item{\code{by_gear}}{Compositions by gear. Columns include REGION_GRP, YEAR, GEAR, LENGTH
(and optionally SEASON, SEX), FREQ, plus sample size summaries.}
}
}
\description{
Builds annual (or seasonal) foreign length compositions by region (and optionally sex),
using observer length frequencies reweighted to foreign catch totals. The weighting follows
a multi-stage approach: within-haul frequency scaling, haul-to-stratum scaling, and expansion
to catch-based totals (overall and by-gear variants).
}
\details{
The function:
\enumerate{
\item Pulls foreign observer length frequency data for \code{species} and requested areas/years.
\item Computes mean weights (AVEWT) at several strata resolutions (YEAR-AREA2-MONTH-GEAR, etc.)
and uses a priority fallback to assign \code{AVEWT} to catch rows.
\item Pulls foreign catch (tons) for \code{for_species_catch} and converts to numbers using AVEWT.
\item Joins observer length data to catch numbers by REGION_GRP/YEAR/AREA2/GEAR/MONTH.
\item Computes weights:
\describe{
\item{\code{WEIGHT1}}{Within-haul share: \code{SUM_FREQUENCY / YAGMH_SFREQ}}
\item{\code{WEIGHT2}}{Haul-to-stratum scaling: \code{YAGMH_SNUM / YAGM_SNUM}}
\item{\code{WEIGHT3}}{Gear share of annual catch numbers: \code{YAGM_TNUM / YG_TNUM}}
\item{\code{WEIGHT4}}{Stratum share of annual catch numbers: \code{YAGM_TNUM / Y_TNUM}}
}
\item Produces normalized compositions \code{FREQ} on a dense 1:maxL grid for:
\itemize{
\item aggregated (by REGION_GRP x YEAR \link{x SEASON} \link{x SEX})
\item by-gear (by REGION_GRP x YEAR x GEAR \link{x SEASON} \link{x SEX})
}
}
}
\seealso{
\code{\link[data.table]{data.table}}, \code{\link[lubridate]{month}}
}
